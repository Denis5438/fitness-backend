import { Telegraf, Markup } from 'telegraf';
import { config } from './config.js';

const bot = new Telegraf(config.telegram.botToken);

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start - Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ WebApp
bot.command('start', (ctx) => {
  const firstName = ctx.from.first_name || 'ÐÑ‚Ð»ÐµÑ‚';
  
  ctx.reply(
    `ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚, ${firstName}!\n\n` +
    `ðŸ’ª Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² **Ð¤Ð¸Ñ‚Ð½ÐµÑ Ð”Ð½ÐµÐ²Ð½Ð¸Ðº** â€” Ñ‚Ð²Ð¾Ð¹ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð´Ð»Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº!\n\n` +
    `ðŸ“ Ð—Ð´ÐµÑÑŒ Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ:\n` +
    `â€¢ Ð’ÐµÑÑ‚Ð¸ Ð´Ð½ÐµÐ²Ð½Ð¸Ðº Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº\n` +
    `â€¢ ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ\n` +
    `â€¢ ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð¾Ñ‚ AI-ÐºÐ¾ÑƒÑ‡Ð°\n` +
    `â€¢ ÐÐ°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº\n\n` +
    `ÐÐ°Ð¶Ð¼Ð¸ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ! ðŸ‘‡`,
    {
      parse_mode: 'Markdown',
      ...Markup.keyboard([
        [Markup.button.webApp('ðŸ‹ï¸ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ', config.telegram.webappUrl)]
      ]).resize()
    }
  );
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /help - Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ
bot.command('help', (ctx) => {
  ctx.reply(
    `â“ **ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ**\n\n` +
    `/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n` +
    `/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ñƒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n` +
    `/stats - Ð¢Ð²Ð¾Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°\n\n` +
    `Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð´Ð½ÐµÐ²Ð½Ð¸ÐºÐ¾Ð¼ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ" ðŸ‘‡`,
    {
      parse_mode: 'Markdown',
      ...Markup.keyboard([
        [Markup.button.webApp('ðŸ‹ï¸ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ', config.telegram.webappUrl)]
      ]).resize()
    }
  );
});

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /stats - Ð±Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° (Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€Ð°ÑÑˆÐ¸Ñ€Ð¸Ñ‚ÑŒ)
bot.command('stats', (ctx) => {
  ctx.reply(
    `ðŸ“Š **Ð¢Ð²Ð¾Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°**\n\n` +
    `Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¾Ñ‚ÐºÑ€Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ðŸ‘‡`,
    {
      parse_mode: 'Markdown',
      ...Markup.keyboard([
        [Markup.button.webApp('ðŸ‹ï¸ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ', config.telegram.webappUrl)]
      ]).resize()
    }
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', (ctx) => {
  ctx.reply(
    `Ð¯ Ð¿Ð¾ÐºÐ° Ð½Ðµ ÑƒÐ¼ÐµÑŽ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ðŸ¤–\n\n` +
    `Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼:`,
    Markup.keyboard([
      [Markup.button.webApp('ðŸ‹ï¸ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ', config.telegram.webappUrl)]
    ]).resize()
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error(`âŒ Error for ${ctx.updateType}:`, err);
  ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
async function startBot() {
  try {
    console.log('ðŸ¤– Starting Telegram bot...');
    
    // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð°
    await bot.telegram.setMyCommands([
      { command: 'start', description: 'ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ' },
      { command: 'help', description: 'ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ' },
      { command: 'stats', description: 'Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°' },
    ]);
    
    await bot.launch();
    console.log('âœ… Telegram bot is running!');
    console.log(`ðŸ“± WebApp URL: ${config.telegram.webappUrl}`);
  } catch (error) {
    console.error('âŒ Failed to start bot:', error);
    process.exit(1);
  }
}

// Graceful shutdown
process.once('SIGINT', () => {
  console.log('\nðŸ›‘ Stopping bot...');
  bot.stop('SIGINT');
});

process.once('SIGTERM', () => {
  console.log('\nðŸ›‘ Stopping bot...');
  bot.stop('SIGTERM');
});

startBot();
